<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<title>Libérez Postgresql</title>
		<meta name="description" content="Why Postgresql rules the world">
		<meta name="author" content="Grégoire HUBERT">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.min.css">
		<link rel="stylesheet" href="css/theme/beige.css" id="theme">
		<link rel="stylesheet" href="css/custom.css">

		<!-- For syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- If the query includes 'print-pdf', use the PDF print sheet -->
		<script>
			document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
                <section>
                    <h1>Libérez Postgresql</h1>
                    <h3>dans vos développements PHP</h3>
                    <p><small>Grégoire HUBERT - PHPTour 2014</small></p>
                </section>
                <section>
                    <h3>À propos</h3>
                    <p>
                    <dl>
                        <dt>Grégoire HUBERT</dt>
                        <dd>PHP &amp; Postgresql depuis 1999</dd>
                        <dd>Auteur de Pomm <a href="http://www.pomm-project.org">Pomm</a></dd>
                        <dd>Fondateur de <a href="http://www.pragmafabrik.com">PragmaFabrik</a></dd>
                        <dd>@chanmix51 @PommProject</dd>
                        <dd><a href="https://joind.in/11220">https://joind.in/11220</a></dd>
                    </dl>
          <img src="images/greg.jpg" style="border: 0px;" height="160" width="120" /><img src="images/logo_pragma.png" style="border: 0px;" height="160", width="420" />
                    </p>
                </section>
                <section>
                    <h3>The (yet) undetected power of Postgresql</h3>
                    <p><img src="images/pg_radar.png" /></p>
                </section>
                <section>
                    <h3>PHP &amp; SQL</h3>
                    <p><img src="images/communication_breakdown.png" /></p>
                    <p>
                      <dl>
                          <dd>Paradigmes différents</dd>
                          <dd>Interface de communication très pauvre</dd>
                      </dl>
                    </p>
                </section>
                <section>
                    <h3>ORM &amp; SQL</h3>
                    <p><img src="images/orms.png" width="60%" height="60%" /></p>
                    <p>
                        <dl>
                            <dd>Impose le modèle OO dans un mode relationnel</dd>
                            <dd>Masque ce qui se passe en base</dd>
                            <dd>Difficile de régler les performances</dd>
                        </dl>
                    </p>
                </section>
                <section>
                    <h3>Comment votre DBA voit vos données</h3>
                    <p><img src="images/dba.png" /></p>
                </section>
                <section>
                    <h3>Comment les dev PHP voient leurs données</h3>
                    <p><img src="images/fridge.png" width="40%" height="40%" style="border: 0px;" /></p>
                </section>
                <section>
                    <h3>Un problème ?</h3>
                    <p>
                    <img src="images/square-peg-round-hole.jpg" />
                        <dl>
                            <dd class="fragment">&#10149; Impose le modèle OO dans un mode relationnel</dd>
                            <dd class="fragment">&#10149; Lie statiquement les entités aux tables</dd>
                            <dd class="fragment">&#10149; Est équivalent à un moteur "<u><code>clé =&gt; entité</code></u>"</dd>
                        <dl>

                    </p>
                </section>
                <section>
                    <h3>Pourquoi ne pas intégrer la logique relationnelle en OO ?</h3>
                    <p>
                        <dl>
                            <dd class="fragment">Les moteurs relationnels manipulent des <strong>ensembles</strong></dd>
                            <dd class="fragment">Les ensembles sont composés de <strong>tuples</strong></dd>
                            <dd class="fragment">Qu'on transforme à l'aide de <strong>projections</strong></dd>
                            <dd class="fragment">Les entités sont des tuples et sont donc extensibles</dd>
                            <dd class="fragment">Les tables sont juste des ensembles persistés</dd>
                        </dl>
                    </p>
                </section>
                <section>
                    <h2>Pomm</h2>
                    <h3>Intégrer la logique relationnelle en OO</h3>
                    <p><img src="images/map.png" width="55%" height="55%" /></p>
                    <p>
                        <dl>
                            <dd>Ensembles projetés en entités</dd>
                            <dd>Valeurs converties depuis / vers la DB</dd>
                            <dd>Type équivalents en PHP</dd>
                        </dl>
                    </p>
                </section>
                <section>
                  <section>
                      <h2>Convertisseurs et types</h2>
                      <p><small>Postgres FTW</small></p>
                  </section>
                    <section>
                      <h3>Un problème d'interface</h3>
                      <code><pre class='vimsql'>
            (<span class="String">&quot;&lt;(3,2),1&gt;&quot;</span>,<span class="String">&quot;{&quot;&quot;2014-05-24 13:59:57.142888+00&quot;&quot;,&quot;&quot;2014-05-24 12:59:57.142888+00&quot;&quot;}&quot;</span>)
                      </pre></code>
                      <p>Que représente cette ligne de données ?</p>
                      <p>Comment l'exploiter ?</p>
                        </section>
                      <section>
                          <h3>Quelques types de Postgres</h3>
                          <p>
                            <ul style="list-style-type: none;">
                                <li>&#10149; boolean, bitchar, bitvar</li>
                                <li>&#10149; strings, uuid, xml, json, inet</li>
                                <li>&#10149; numbers, timestamps with time zone, intervals</li>
                            <li>&#10149; integer and timestamps, ranges</li>
                            <li>&#10149; point, circle, segment, box, polygon</li>
                            <li>&#10149; HStore, LTree, ts_vector, bytea</li>
                            <li>&#10149; Types composites, objets</li>
                            <li>&#10149; Tableaux de tous les types listés</li>
                            <li>&#10149; <font color="red">Ajoutez votre type ici</font></li>
                        </ul>
                      </p>
                  </section>
                  <section>
                      <h3>Convertisseurs de Pomm</h3>
                      <p>
                        <ul style="list-style-type: none;">
                            <li>&#10149; boolean, <strike>bitchar, bitvar</strike></li>
                            <li>&#10149; strings, uuid, xml, json, inet</li>
                            <li>&#10149; numbers, timestamps with time zone, intervals</li>
                            <li>&#10149; integer and timestamps, ranges</li>
                            <li>&#10149; point, circle, segment, <strike>box, polygon</strike></li>
                            <li>&#10149; HStore, LTree, ts_vector, bytea</li>
                            <li>&#10149; Types composites, objets</li>
                            <li>&#10149; Tableaux de tous les types listés</li>
                            <li>&#10149; <font color="red">Ajoutez votre type ici</font></li>
                        </ul>
                      </p>
                  </section>
                  <section>
                      <h3>Convertisseurs par défaut</h3>
                      <p>
                        <ul style="list-style-type: none;">
                          <li class="fragment">Pg <code>[t|f]</code> &lt;=&gt; PHP <code>(bool) [true|false]</code></li>
                          <li class="fragment">Pg timestamps &lt;=&gt; <code>DateTime</code> instances</li>
                          <li class="fragment">Pg intervals &lt;=&gt; <code>DateInterval</code> instances</li>
                          <li class="fragment">Pg ranges &lt;=&gt; Own range instances</li>
                          <li class="fragment">Pg arrays &lt;=&gt; Tableaux PHP avec contenu converti</li>
                          <li class="fragment">Facile à surcharger</li>
                        </ul>
                      </p>
                  </section>
                  <section>
                    <h3>Ajouter des convertisseurs</h3>
                    <p>
                      <ul style="list-style-type: none;">
                        <li>Point: <code>'(1,1)'</code></li>
                        <li class="fragment"><code><pre class="vimphp"><span class="Operator">$</span><span class="Identifier">database</span><span class="Structure">-&gt;</span>registerConverter<span class="Special">(</span>
    '<span class="String">Point</span>',
    <span class="Define">new</span> \Pomm\Converter\PgPoint<span class="Special">()</span>,
    <span class="Special">[</span>'<span class="String">point</span>'<span class="Special">])</span>;</pre></code></li>
                        <li class="fragment">PHP: <code>\Pomm\Type\Point</code> instance</li>
                        <li class="fragment"><code><pre class="vimphp"><span class="Operator">$</span><span class="Identifier">entity</span><span class="Structure">-&gt;</span>coords<span class="Structure">-&gt;</span>x</pre></code></li>
                      </ul>
                    </p>
                  </section>
                  <section>
                    <h3>Domaines &amp; sous types</h3>
                    <p>
                      <ul style="list-style-type: none;">
                        <li><code><pre class="vimsql">
<span class="Statement">CREATE</span> DOMAIN latlong <span class="Special">AS</span> <span class="Type">point</span> <span class="Special">CHECK</span> (
    value[<span class="Number">0</span>] &lt;= <span class="Number">180</span> <span class="Statement">and</span> value[<span class="Number">0</span>] &gt;= <span class="Number">-180</span> <span class="Statement">and</span>
    value[<span class="Number">1</span>] &gt;= <span class="Number">-90</span> <span class="Statement">and</span> value[<span class="Number">1</span>] &lt;= <span class="Number">90</span>
);</pre></code></li>
                        <li class="fragment"><code><pre class="vimphp"><span class="Operator">$</span><span class="Identifier">database</span>
    <span class="Structure">-&gt;</span>registerConverter<span class="Special">(</span>'<span class="String">LatLong</span>', <span class="Define">new</span> \Pomm\Converter\PgPoint<span class="Special">()</span>, <span class="Special">[</span>'<span class="String">point</span>', '<span class="String">public.latlong</span>'<span class="Special">])</span>;</pre></code></li>
                      </ul>
                    </p>
                  </section>

                  <section>
                    <h3>LTree: chemins matérialisés</h3>
                    <p>
                    Utiles pour représenter des arbres à plat et des catégories (tags)
                      <ul style="list-style-type: none;">
                        <li><code><pre class="vimsql"><span class="Statement">CREATE</span> <span class="Special">EXTENSION</span> ltree;</pre></code></li>
                        <li>Pg «<code>out.restaurant.italian</code>»</li>
                        <li>PHP «<code>['out', 'restaurant', 'italian']</code>»</li>
                      </ul>
                    </p>
                  </section>
                  <section>
                    <h3>HStore</h3>
                    <p>Type clé =&gt; valeur
                      <ul style="list-style-type: none;">
                        <li><code><pre class="vimsql"><span class="Statement">CREATE</span> <span class="Special">EXTENSION</span> hstore;</pre></code></li>
                        <li>Pg «<code>'{"pika" =&gt; "chu", "plop" =&gt; "1" }'</code>»</li>
                        <li>PHP «<code>["pika" =&gt; "chu", "plop" =&gt; "1" ]</code>»</li>
                      </ul>
                    </p>
                  </section>
                  <section>
                      <h3>Fabriquez vos propres types</h3>
                      <p>Pour stocker des données complexes</p>
                      <p>Example: enroulements de transformateurs électriques :
                      <ul>
                          <li>Ils sont composés de :</li>
                          <li>1 enroulement primaire</li>
                          <li>n enroulements secondaires</li>
                      </ul>
                      </p>
                      <code><pre class="vimsql"><span class="Statement">CREATE</span> TYPE winding <span class="Special">AS</span> (voltage <span class="Type">numeric</span>(<span class="Number">5</span>,<span class="Number">1</span>), current <span class="Type">numeric</span>(<span class="Number">5</span>,<span class="Number">3</span>));</pre></code>
                      <code class="fragment"><pre class="vimsql"><span class="Statement">CREATE</span> <span class="Special">TABLE</span> power_supply (
      <span class="Comment">-- autres champs</span>
  <span class="String">&quot;primary&quot;</span> winding <span class="Statement">NOT</span> <span class="Special">NULL</span>,
  <span class="String">&quot;secondaries&quot;</span> winding[] <span class="Statement">NOT</span> <span class="Special">NULL</span>,
      <span class="Comment">-- autres champs</span></pre></code>
                  </section>
                  <section>
                      <h3>Créer le convertisseur associé</h3>
                      <p>Pour les types composites</p>
                      <code><pre class="vimphp">
      <span class="Operator">$</span><span class="Identifier">database</span><span class="Structure">-&gt;</span>registerConverter<span class="Special">(</span>
          '<span class="String">Winding</span>',
          <span class="Define">new</span> PgRow<span class="Special">(</span>
              <span class="Operator">$</span><span class="Identifier">database</span>,
              <span class="Define">new</span> RowStructure<span class="Special">([</span>'<span class="String">voltage</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> '<span class="String">numeric</span>', '<span class="String">current</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> '<span class="String">numeric</span>'<span class="Special">])</span>
              <span class="Special">)</span>,
          <span class="Special">[</span>'<span class="String">transformer.winding</span>'<span class="Special">]</span>
          <span class="Special">)</span>;
                      </pre></code>
                  </section>
                  <section>
                      <h3>Créer le type composite</h3>
                      <code><pre class="vimphp">
<span class="lnr"> 1 </span><span class="Special">&lt;?php</span>
<span class="lnr"> 2 </span><span class="Structure">namespace</span> My\Database\Type;
<span class="lnr"> 3 </span>
<span class="lnr"> 4 </span><span class="Include">use</span> \Pomm\Type\Composite;
<span class="lnr"> 5 </span>
<span class="lnr"> 6 </span><span class="Structure">class</span> Address <span class="Structure">extends</span> Composite
<span class="lnr"> 7 </span><span class="Special">{</span>
<span class="lnr"> 8 </span>    <span class="StorageClass">public</span> <span class="Operator">$</span><span class="Identifier">voltage</span>;
<span class="lnr"> 9 </span>    <span class="StorageClass">public</span> <span class="Operator">$</span><span class="Identifier">current</span>;
<span class="lnr">10 </span><span class="Special">}</span>
                      </pre></code>
                  </section>
                  <section>
                      <h3>Objets</h3>
                      <p>Créer une table dans Postgres c'est créer un type composite</p>

                      <code class="fragment"><pre class="vimsql">
  <span class="Statement">SELECT</span> pika,chu <span class="Special">FROM</span> plop;
  ┌──────┬─────┐
  │ pika │ chu │
  ├──────┼─────┤
  │ a    │   1 │
  │ b    │   2 │
  │ c    │   3 │
  └──────┴─────┘
  (3 lines)
                      </pre></code>
                  </section>
                  <section>
                      <h3>Objets !</h3>
                      <p>Créer une table dans Postgres c'est créer un type composite</p>
                      <code><pre class="vimsql">
  <span class="Statement">SELECT</span> plop <span class="Special">FROM</span> plop;
  ┌───────┐
  │ plop  │
  ├───────┤
  │ (a,1) │
  │ (b,2) │
  │ (c,3) │
  └───────┘
  (3 lines)
                      </pre></code>
                  </section>
                </section>
                <section>
                  <section>
                    <h3>Le système de projection</h3>
                    <p><img src="images/map.png" width="55%" height="55%" /></p>
                  </section>
                  <section>
                    <h3>Qu'est ce qu'une projection ?</h3>
                    <p>En SQL, une projection est la liste des champs retournée par un <code>SELECT</code> :</p>
                    <code><pre class="vimsql">
<span class="Statement">SELECT</span>
  <span class="String">&quot;field1&quot;</span> <span class="Special">AS</span> <span class="String">&quot;fieldA&quot;</span>,
  <span class="String">&quot;field2&quot;</span> <span class="Special">AS</span> <span class="String">&quot;fieldB&quot;</span>,
  ...
  <span class="String">&quot;fieldN&quot;</span> <span class="Special">AS</span> <span class="String">&quot;fieldX&quot;</span>
<span class="Special">FROM</span> ...
                    </pre></code>
                  </section>
                  <section>
                    <h3>Gérer la projection</h3>
                    <p>Définir ce qui sera hydraté dans les entités « souples »</p>
                    <code><pre class="vimphp">
<span class="Operator">$</span><span class="Identifier">fields</span> <span class="Operator">=</span> <span class="Operator">$</span><span class="Identifier">map</span><span class="Structure">-&gt;</span>getSelectFields<span class="Special">()</span>;
    <span class="Special">[</span>
    '<span class="String">fieldA</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> '<span class="String">field1</span>',
    '<span class="String">fieldB</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> '<span class="String">field2</span>',
    <span class="Operator">...</span>
    '<span class="String">fieldX</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> '<span class="String">fieldN</span>'
    <span class="Special">]</span>
                    </pre></code>
                  </section>
                <section>
                    <h3>Projection : l'opération "SELECT"</h3>
                      <code><pre class="vimphp">
<span class="Operator">$</span><span class="Identifier">student</span> <span class="Operator">=</span> <span class="Operator">$</span><span class="Identifier">studentMap</span><span class="Structure">-&gt;</span>findByPK<span class="Special">([</span>'<span class="String">student_id</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> <span class="Number">3</span><span class="Special">)</span>;

<span class="fragment">instance of &quot;<span class="String">Student</span>&quot; <span class="Operator">=</span><span class="Operator">&gt;</span> <span class="Special">{</span>
    '<span class="String">student_id</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> <span class="Number">3</span>,
    '<span class="String">first_name</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> '<span class="String">pika</span>',
    '<span class="String">last_name</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> '<span class="String">chu</span>',
    '<span class="String">birthdate</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> instance of DateTime <span class="Operator">=</span><span class="Operator">&gt;</span> <span class="Special">{</span><span class="Operator">...</span>
    '<span class="String">password</span>'  <span class="Operator">=</span><span class="Operator">&gt;</span> '<span class="String">32ªØ~ぜ</span>',
    <span class="Operator">...</span>
<span class="Special">}</span></span>
                      </pre></code>
                </section>
                <section>
                    <h3>Modifions la projection</h3>
                    <code><pre class="vimphp">
<span class="StorageClass">public</span> <span class="Define">function</span> getSelectFields<span class="Special">(</span><span class="Operator">$</span><span class="Identifier">alias</span> <span class="Operator">=</span> <span class="Type">null</span><span class="Special">)</span>
<span class="Special">{</span>
    <span class="fragment"><span class="Operator">$</span><span class="Identifier">fields</span> <span class="Operator">=</span> <span class="Structure">parent</span><span class="Operator">::</span>getSelectFields<span class="Special">(</span><span class="Operator">$</span><span class="Identifier">alias</span><span class="Special">)</span>;</span>
    <span class="fragment"><span class="Operator">unset</span><span class="Special">(</span><span class="Operator">$</span><span class="Identifier">fields</span><span class="Special">[</span>'<span class="String">password</span>'<span class="Special">])</span>;</span>
    <span class="fragment"><span class="Operator">$</span><span class="Identifier">fields</span><span class="Special">[</span>'<span class="String">age</span>'<span class="Special">]</span> <span class="Operator">=</span> <span class="Function">sprintf</span><span class="Special">(</span>
        &quot;<span class="String">age(%s)</span>&quot;,
        <span class="Operator">$</span><span class="Identifier">this</span><span class="Structure">-&gt;</span>aliasField<span class="Special">(</span>'<span class="String">birthdate</span>', <span class="Operator">$</span><span class="Identifier">alias</span><span class="Special">)</span>
        <span class="Special">)</span>;

    <span class="Statement">return</span> <span class="Operator">$</span><span class="Identifier">fields</span>;</span>
<span class="Special">}</span>
                    </pre></code>
                </section>
                <section>
                    <h3>Entité modifiée</h3>
                      <code><pre class="vimphp">
<span class="Operator">$</span><span class="Identifier">student</span> <span class="Operator">=</span> <span class="Operator">$</span><span class="Identifier">studentMap</span><span class="Structure">-&gt;</span>findByPK<span class="Special">([</span>'<span class="String">student_id</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> <span class="Number">3</span><span class="Special">)</span>;

instance of &quot;<span class="String">Student</span>&quot; <span class="Operator">=</span><span class="Operator">&gt;</span> <span class="Special">{</span>
    '<span class="String">student_id</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> <span class="Number">3</span>,
    '<span class="String">first_name</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> '<span class="String">pika</span>',
    '<span class="String">last_name</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> '<span class="String">chu</span>',
    '<span class="String">birthdate</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> instance of DateTime <span class="Operator">=</span><span class="Operator">&gt;</span> <span class="Special">{</span><span class="Operator">...</span>
    '<span class="String">age</span>'       <span class="Operator">=</span><span class="Operator">&gt;</span> '<span class="String">17 years 3 mons 28 days</span>'
    <span class="Operator">...</span>
<span class="Special">}</span>
                      </pre></code>
                </section>
                <section>
                  <h3>Ajoutons les convertisseurs pour les nouveaux champs</h3>
                    <code><pre class="vimphp">
<span class="Structure">class</span> StudentMap <span class="Structure">extends</span> BaseStudentMap
<span class="Special">{</span>
    <span class="StorageClass">public</span> <span class="Define">function</span> initialize<span class="Special">()</span>
    <span class="Special">{</span>
        <span class="Structure">parent</span><span class="Operator">::</span>initialize<span class="Special">()</span>;

        <span class="Operator">$</span><span class="Identifier">this</span><span class="Structure">-&gt;</span>addVirtualField<span class="Special">(</span>'<span class="String">age</span>', '<span class="String">interval</span>'<span class="Special">)</span>;
    <span class="Special">}</span>
    <span class="Operator">...</span>
                    </pre></code>
                </section>
                <section>
                    <h3>Entité modifiée</h3>
                      <code><pre class="vimphp">
<span class="Operator">$</span><span class="Identifier">student</span> <span class="Operator">=</span> <span class="Operator">$</span><span class="Identifier">studentMap</span><span class="Structure">-&gt;</span>findByPK<span class="Special">([</span>'<span class="String">student_id</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> <span class="Number">3</span><span class="Special">)</span>;

instance of &quot;<span class="String">Student</span>&quot; <span class="Operator">=</span><span class="Operator">&gt;</span> <span class="Special">{</span>
    '<span class="String">student_id</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> <span class="Number">3</span>,
    '<span class="String">first_name</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> '<span class="String">pika</span>',
    '<span class="String">last_name</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> '<span class="String">chu</span>',
    '<span class="String">birthdate</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> instance of DateTime <span class="Operator">=</span><span class="Operator">&gt;</span> <span class="Special">{</span><span class="Operator">...</span>
    '<span class="String">age</span>'       <span class="Operator">=</span><span class="Operator">&gt;</span> instance of DateInterval <span class="Operator">=</span><span class="Operator">&gt;</span> <span class="Special">{</span><span class="Operator">...</span>
    <span class="Operator">...</span>
<span class="Special">}</span>
                      </pre></code>
                </section>
                <section>
                    <h3>Projection : l'opérateur "RETURNING"</h3>
                    <p> 'INSERT', 'UPDATE' and 'DELETE' peuvent également être projetés avec l'opérateur <code>RETURNING</code> :</p>
                    <code><pre class="vimsql">
<span class="Statement">DELETE</span> <span class="Special">FROM</span> student
  <span class="Special">WHERE</span> student_id = <span class="Number">3</span>
<span class="Special">RETURNING</span> <span class="String">&quot;field1&quot;</span> <span class="Special">AS</span> <span class="String">&quot;fieldA&quot;</span>, ...
                      </pre></code>
                </section>
                <section>
                    <h3>Entité effacée</h3>
                      <code><pre class="vimphp">
<span class="Operator">$</span><span class="Identifier">student</span> <span class="Operator">=</span> <span class="Operator">$</span><span class="Identifier">studentMap</span><span class="Structure">-&gt;</span>deleteByPK<span class="Special">([</span>'<span class="String">student_id</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> <span class="Number">3</span><span class="Special">)</span>;

instance of &quot;<span class="String">Student</span>&quot; <span class="Operator">=</span><span class="Operator">&gt;</span> <span class="Special">{</span>
    '<span class="String">student_id</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> <span class="Number">3</span>,
    '<span class="String">first_name</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> '<span class="String">pika</span>',
    '<span class="String">last_name</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> '<span class="String">chu</span>',
    '<span class="String">birthdate</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> instance of DateTime <span class="Operator">=</span><span class="Operator">&gt;</span> <span class="Special">{</span><span class="Operator">...</span>
    '<span class="String">age</span>'       <span class="Operator">=</span><span class="Operator">&gt;</span> instance of DateInterval <span class="Operator">=</span><span class="Operator">&gt;</span> <span class="Special">{</span><span class="Operator">...</span>
    <span class="Operator">...</span>
<span class="Special">}</span>
                      </pre></code>
                  </section>
                  <section>
                    <h3>Faire simple</h3>
                    <code><pre class="vimphp">
<span class="StorageClass">public</span> <span class="Define">function</span> deleteController<span class="Special">(</span><span class="Operator">$</span><span class="Identifier">id</span><span class="Special">)</span>
<span class="Special">{</span>
    <span class="Operator">$</span><span class="Identifier">student</span> <span class="Operator">=</span> <span class="Operator">$</span><span class="Identifier">this</span><span class="Structure">-&gt;</span>app<span class="Special">[</span>'<span class="String">pomm</span>'<span class="Special">]</span>
        <span class="Structure">-&gt;</span>getMapFor<span class="Special">(</span>'<span class="String">\App\School\Student</span>'<span class="Special">)</span>
        <span class="Structure">-&gt;</span>deleteByPK<span class="Special">([</span>'<span class="String">student_id</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> <span class="Operator">$</span><span class="Identifier">id</span><span class="Special">])</span>;

    <span class="Statement">if</span> <span class="Special">(</span><span class="Operator">!</span><span class="Operator">$</span><span class="Identifier">student</span><span class="Special">)</span> <span class="Special">{</span>
        <span class="Statement">return</span> <span class="Operator">$</span><span class="Identifier">this</span><span class="Structure">-&gt;</span>app<span class="Structure">-&gt;</span>abort<span class="Special">(</span>&quot;<span class="String">not found</span>&quot;, <span class="Number">404</span><span class="Special">)</span>;
    <span class="Special">}</span>

    <span class="Statement">return</span> <span class="Function">json_encode</span><span class="Special">(</span><span class="Operator">$</span><span class="Identifier">student</span><span class="Structure">-&gt;</span>export<span class="Special">())</span>;
<span class="Special">}</span>
                    </pre></code>
                  </section>
                </section>
                <section>
                    <section>
                        <h2>Requêter</h2>
                        <div class="fragment">
                        <h3>Les types ne sont rien sans</h3>
                        <h3>leurs opérateurs et fonctions</h3>
                        <p><small>yes, Postgres is awesome</small></p>
                      </div>
                    </section>
                    <section>
                        <h3>Réseau</h3>
                        <p>Cette adresses appartient elle à tel réseau ?</p>
                        <code class="fragment"><pre class="vimsql"><span class="Statement">SELECT</span> <span class="Type">inet</span> <span class="String">'172.17.0.2'</span> &lt;&lt;  <span class="Type">inet</span> <span class="String">'172.16.0.0/12'</span>;</pre></code>
                        <p class="fragment">Trouver toutes les IP dans le réseau</p>
                        <code class="fragment"><pre class="vimphp"><span class="Operator">$</span><span class="Identifier">computers</span> <span class="Operator">=</span> <span class="Operator">$</span><span class="Identifier">connection</span><span class="Structure">-&gt;</span>getMapFor<span class="Special">(</span>'<span class="String">Db\Network\Computer</span>'<span class="Special">)</span>
    <span class="Structure">-&gt;</span>findWhere<span class="Special">(</span>'<span class="String">ip_address &lt;&lt; $*</span>', <span class="Special">[</span><span class="Identifier">$network</span><span class="Special">])</span> ;</pre></code>
                    </section>
                    <section>
                        <h3>Ranges</h3>
                          <p>Ces 2 intervales sont il contigus ?</p>
                          <code class="fragment"><pre class="vimsql"><span class="Statement">SELECT</span> numrange(<span class="Number">1.1</span>, <span class="Number">2.2</span>) -|- numrange(<span class="Number">2.2</span>, <span class="Number">3.3</span>);</pre></code>
                          <p class="fragment">Quel est le programme TV après celui-là ?</p>
                          <code class="fragment"><pre class="vimphp">
<span class="Operator">$</span><span class="Identifier">programs</span> <span class="Operator">=</span> <span class="Operator">$</span><span class="Identifier">connection</span><span class="Structure">-&gt;</span>getMapFor<span class="Special">(</span>'<span class="String">Db\App\Program</span>'<span class="Special">)</span>
    <span class="Structure">-&gt;</span>findWhere<span class="Special">(</span>&quot;<span class="String">hours -|- tsrange(null, $*) and channel = $*</span>&quot;, <span class="Special">[</span><span class="Operator">$</span><span class="Identifier">end_hour</span>, <span class="Operator">$</span><span class="Identifier">channel</span><span class="Special">])</span>
;
                          </pre></code>
                    </section>
                    <section>
                        <h3>Geometrie</h3>
                          <p>Quel est le point de croisement de 2 segments ?</p>
                          <code class="fragment"><pre class="vimsql"><span class="Statement">SELECT</span> <span class="Type">lseg</span> <span class="String">'((1,-1),(-1,1))'</span> # <span class="Type">lseg</span> <span class="String">'((1,1),(-1,-1))'</span>;</pre></code>
                          <p class="fragment">Ces 2 segments sont ils perpendiculaires ?</p>
                          <code class="fragment"><pre class="vimsql"><span class="Statement">SELECT</span> <span class="Type">lseg</span> <span class="String">'((1,-1),(-1,1))'</span> ?-| <span class="Type">lseg</span> <span class="String">'((1,1),(-1,-1))'</span>;</pre></code>
                    </section>
                    <section>
                        <h3>Geometrie</h3>
                          <p>Un peu plus utile, la distance entre deux points ?</p>
                          <code class="fragment"><pre class="vimsql"><span class="Statement">SELECT</span>  <span class="Type">point</span> <span class="String">'(0,0)'</span> &lt;-&gt; <span class="Type">point</span> <span class="String">'(1,1)'</span>;</pre></code>
                          <p class="fragment">Les stations de vélo proches de moi ?</p>
                          <code class="fragment"><pre class="vimphp">
    <span class="Structure">-&gt;</span>getMapFor<span class="Special">(</span>'<span class="String">\City\Station</span>'<span class="Special">)</span>
    <span class="Structure">-&gt;</span>findWhere<span class="Special">(</span>&quot;<span class="String">circle(point($*, $*), $*) @&gt; position)</span>&quot;, <span class="Special">[</span><span class="Operator">$</span><span class="Identifier">pos_x</span>, <span class="Operator">$</span><span class="Identifier">pos_y</span>, <span class="Operator">$</span><span class="Identifier">radius</span><span class="Special">])</span>;
                          </pre></code>
                    </section>
                    <section>
                        <h3>Tableaux</h3>
                        <p>Chercher des éléments</p>
                        <code class="fragment"><pre class="vimsql"><span class="Statement">SELECT</span> <span class="Number">2</span> = <span class="Statement">ANY</span>(<span class="Special">ARRAY</span>[<span class="Number">1</span>, <span class="Number">2</span>, <span class="Number">4</span>]);</pre></code>
                        <p class="fragment">Trouver un PC à partir d'une de ses IP</p>
                        <code class="fragment"><pre class="vimphp"><span class="Operator">$</span><span class="Identifier">computers</span> <span class="Operator">=</span> <span class="Operator">$</span><span class="Identifier">connection</span><span class="Structure">-&gt;</span>getMapFor<span class="Special">(</span>'<span class="String">Db\Network\Computer</span>'<span class="Special">)</span>
    <span class="Structure">-&gt;</span>findWhere<span class="Special">(</span>&quot;<span class="String">$* = ANY(interfaces)</span>&quot;, <span class="Special">[</span><span class="Operator">$</span><span class="Identifier">ip_address</span><span class="Special">])</span>
;</pre></code>

                    </section>
                  <section>
                      <h3>HStore: clé =&gt; valeur</h3>
                      <p>
                        <ul style="list-style-type: none;">
                            <li class="fragment">Champs optionnels</li>
                            <li class="fragment">I18N: <code><pre class="vimsql"><span class="Statement">SELECT</span> label-&gt;en <span class="Special">AS</span> label <span class="Special">FROM</span> product;</pre></code></li>
                        </ul>
                      </p>
                  </section>
                  <section>
                      <h3>JSON</h3>
                      <p>
                        <ul style="list-style-type: none;">
                            <li class="fragment">Support natif de JSON</li>
                            <li class="fragment"><code><pre class="vimphp">
<span class="Operator">$</span><span class="Identifier">map</span><span class="Structure">-&gt;</span>findWhere<span class="Special">(</span>&quot;<span class="String">social_networks-&gt;&gt;$* &lt;&gt; ''</span>&quot;, <span class="Special">[</span>'<span class="String">facebook</span>'<span class="Special">])</span>;</pre></code></li>
                            <li class="fragment">Converti en tableaux assoc. PHP via <code>json_decode()</code></li>
                        </ul>
                      </p>
                  </section>
                  <section>
                    <h3>Requêtes complexes</h3>
                    <p>Récupérer le nombre de commentaires d'un article</p>
                    <p>Je peux créer ma propre requête</p>
                    <ul style="list-style-type: none;">
                      <li>Gérer la liste des champs</li>
                      <li>Gérer le nom des tables</li>
                    </ul>
                  </section>
                  <section>
                    <h3>Requêtes personnalisées</h3>
                    <h4>Les formateurs</h4>
                    <code><pre class="vimphp">
    <span class="StorageClass">public</span> <span class="Define">function</span> getArticleWithComments<span class="Special">(</span><span class="Operator">$</span><span class="Identifier">article_id</span><span class="Special">)</span>
    <span class="Special">{</span>
        <span class="Operator">$</span><span class="Identifier">sql</span> <span class="Operator">=</span> <span class="Operator">&lt;&lt;&lt;</span><span class="Special">SQL</span>
<span class="Statement">SELECT</span>
    :article_fields,
    <span class="Function">count</span>(c.*) <span class="Special">AS</span> comment_count
<span class="Special">FROM</span>
    :article_table a
      <span class="Special">LEFT JOIN</span> :comment_table c <span class="Special">USING</span> (article_id)
<span class="Special">WHERE</span>
    a.article_id = $*
<span class="Special">GROUP</span> <span class="Special">BY</span>
    a.article_id
<span class="Special">SQL</span>;</pre></code>
                  </section>
                  <section>
                    <h3>Requêtes personnalisées</h3>
                    <h4>Les formateurs</h4>
                    <code><pre class="vimphp">
        <span class="Operator">$</span><span class="Identifier">sql</span> <span class="Operator">=</span> <span class="Function">strtr</span><span class="Special">(</span><span class="Operator">$</span><span class="Identifier">sql</span>, <span class="Special">[</span>
            '<span class="String">:article_fields</span>' <span class="Operator">=</span><span class="Operator">&gt;</span> <span class="Operator">$</span><span class="Identifier">this</span><span class="Structure">-&gt;</span>formatFieldsWithAlias<span class="Special">(</span>'<span class="String">getSelectFields</span>', '<span class="String">a</span>'<span class="Special">)</span>,
            '<span class="String">:article_table</span>'  <span class="Operator">=</span><span class="Operator">&gt;</span> <span class="Operator">$</span><span class="Identifier">this</span><span class="Structure">-&gt;</span>getTableName<span class="Special">()</span>,
            '<span class="String">:comment_table</span>'  <span class="Operator">=</span><span class="Operator">&gt;</span> <span class="Operator">$</span><span class="Identifier">this</span><span class="Structure">-&gt;</span>connection<span class="Structure">-&gt;</span>getMapFor<span class="Special">(</span>'<span class="String">Blog\Comment</span>'<span class="Special">)</span><span class="Structure">-&gt;</span>getTableName<span class="Special">()</span>
        <span class="Special">])</span>;

        <span class="Statement">return</span> <span class="Operator">$</span><span class="Identifier">this</span><span class="Structure">-&gt;</span>query<span class="Special">(</span><span class="Operator">$</span><span class="Identifier">sql</span>, <span class="Special">[</span><span class="Operator">$</span><span class="Identifier">article_id</span><span class="Special">])</span>;
    <span class="Special">}</span>
                    </pre></code>
                    </section>
                    <section>
                      <h3>Custom queries</h3>
                      <h4>Use the objects Luke</h4>
                      <code><pre class="vimphp">
      <span class="StorageClass">public</span> <span class="Define">function</span> getArticleWithComments<span class="Special">(</span><span class="Operator">$</span><span class="Identifier">article_id</span><span class="Special">)</span>
      <span class="Special">{</span>
          <span class="Operator">$</span><span class="Identifier">sql</span> <span class="Operator">=</span> <span class="Operator">&lt;&lt;&lt;</span><span class="Special">SQL</span>
  <span class="Statement">SELECT</span>
      :article_fields,
      <span class="Function">array_agg</span>(c) <span class="Special">AS</span> comments
  <span class="Special">FROM</span>
      :article_table a
        <span class="Special">LEFT JOIN</span> :comment_table c <span class="Special">USING</span> (article_id)
  <span class="Special">WHERE</span>
      a.article_id = $*
  <span class="Special">GROUP</span> <span class="Special">BY</span>
      a.article_id
  <span class="Special">SQL</span>;</pre></code>
                    </section>
                    <section>
                      <h3>SQL a mauvaise réputation</h3>
                      <ul style="list-style-type: none;">
                        <li class="fragment">Gérer les listes de champs</li>
                        <li class="fragment"><code><pre class="vimsql">SELECT ... FROM (SELECT ... </pre></code></li>
                        <li class="fragment">Fastidieux à écrire et déboguer</li>
                      </ul>
                </section>
                <section>
                  <h3>SQL peut être votre meilleur ami</h3>
                  <ul style="list-style-type: none;">
                    <li>&#10149; Paradigme declaratif</li>
                    <li>&#10149; Puissant langage de manipulation des données</li>
                    <li>&#10149; Utilisez <code>WITH</code> pour faire des sous requêtes</li>
                  </ul>
                </section>
                <section>
                  <h3>la clause <code>WITH</code></h3>
                  <p>Si je veux seulement les 5 derniers commentaires ?</p>
                  <code><pre class="vimphp">
    <span class="StorageClass">public</span> <span class="Define">function</span> getArticleWithComments<span class="Special">(</span><span class="Operator">$</span><span class="Identifier">article_id</span><span class="Special">)</span>
    <span class="Special">{</span>
        <span class="Operator">$</span><span class="Identifier">sql</span> <span class="Operator">=</span> <span class="Operator">&lt;&lt;&lt;</span><span class="Special">SQL</span>
<span class="Special">WITH</span>
    last_comment <span class="Special">AS</span> (
        <span class="Statement">SELECT</span> :comment_fields
        <span class="Special">FROM</span> :comment_table c
        <span class="Special">WHERE</span> c.article_id = $*
        <span class="Special">ORDER</span> <span class="Special">BY</span> c.created_at <span class="Special">DESC</span> <span class="Special">LIMIT</span> <span class="Number">5</span>
)
<span class="Statement">SELECT</span>
    :article_fields,
    <span class="Function">array_agg</span>(c) <span class="Special">AS</span> comments
<span class="Special">FROM</span> :article_table a, last_comment c
<span class="Special">WHERE</span> a.article_id = $*
<span class="Special">GROUP</span> <span class="Special">BY</span> a.article_id
<span class="Special">SQL</span>;
                  </pre></code>
                </section>
                  <section>
                    <h3>Fonctions fenêtrées</h3>
                    <p>Groupes de données sur critère</p>
                    <ul style="list-style-type: none;">
                      <li class="fragment">Comment avoir l'ID de l'article suivant &amp; précédent ?</li>
                      <li class="fragment">Les fonctions<code>lag()</code> et <code>lead()</code></li>
                      <li class="fragment">Comment classer des usines par pays par ordre de production ?</li>
                      <li class="fragment">La fonction <code>rank()</code></li>
                    </ul>
                  </section>
                  <section>
                    <h3>File de messages asynchone</h3>
                    <p>Déclencher des travaux détachés ?</p>
                    <p>Utiliser le mécanisme <code>LISTEN / NOTIFY</code> de Postgres.</p>
                    <code class="fragment"><pre class="vimphp">
<span class="StorageClass">public</span> <span class="Define">function</span> addCommentController<span class="Special">()</span>
<span class="Special">{</span>
    <span class="Operator">...</span>
    <span class="Statement">if</span> <span class="Special">(</span><span class="Operator">$</span><span class="Identifier">comment_form</span><span class="Structure">-&gt;</span>isValid<span class="Special">())</span>
    <span class="Special">{</span>
      <span class="Operator">$</span><span class="Identifier">comment</span> <span class="Operator">=</span> <span class="Operator">$</span><span class="Identifier">this</span><span class="Structure">-&gt;</span>app<span class="Special">[</span>'<span class="String">pomm</span>'<span class="Special">]</span>
          <span class="Structure">-&gt;</span>getMapFor<span class="Special">(</span>'<span class="String">\Blog\Comment</span>'<span class="Special">)</span>
          <span class="Structure">-&gt;</span>createAndSaveObject<span class="Special">(</span><span class="Operator">$</span><span class="Identifier">comment_form</span><span class="Structure">-&gt;</span>getValues<span class="Special">())</span>;
      <span class="Operator">$</span><span class="Identifier">this</span><span class="Structure">-&gt;</span>app<span class="Special">[</span>'<span class="String">pomm</span>'<span class="Special">]</span>
          <span class="Structure">-&gt;</span>notify<span class="Special">(</span>'<span class="String">db.change</span>', <span class="Function">json_encode</span><span class="Special">(</span><span class="Operator">$</span><span class="Identifier">comment</span><span class="Structure">-&gt;</span>export<span class="Special">()))</span>;
                    </pre></code>
                </section>
              </section>
                <section>
                    <h2>Pomm</h2>
                    <h3>Intégrer le relationel en OO</h3>
                    <p><img src="images/omms.png" width="55%" height="55%" /></p>
                    <p>
                        <dl>
                            <dd>Façonnez vos données d'après votre métier</dd>
                            <dd>Gardez la main sur les performances</dd>
                        </dl>
                    </p>
                </section>
                <section>
                  <h2>OMMs Vs ORMs</h2>
                    <ul style="list-style-type: none;">
                      <li>&#10149; ORMs et OMMs sont deux approches différentes</li>
                      <li class="fragment">&#10149; Pour du développement générique, ORM + DBAL fonctionne</li>
                      <li class="fragment">&#10149; Pour les développements orientés métier, DBAL est contre-productif</li>
                      <li class="fragment">&#10149; OMMs permettent aux développeurs de profiter de 30 ans d'expérience des BDD</li>
                    </ul>
                </section>
                <section>
                  <h1>Merci</h1>
                  <h2>Des questions ?</h2>
                  <p><a href="https://joind.in/11220">https://joind.in/11220</a></p>
                </section>
            </div><!-- slides -->
            <p><small>&nbsp;www.pomm-project.org</small></p>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.min.js"></script>

		<script>

			// Full list of configuration options available here:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
				transition: Reveal.getQueryHash().transition || 'fade', // default/cube/page/concave/zoom/linear/fade/none

				// Parallax scrolling
				// parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
				// parallaxBackgroundSize: '2100px 900px',

				// Optional libraries used to extend on reveal.js
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
					{ src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
				]
			});

		</script>

	</body>
</html>
